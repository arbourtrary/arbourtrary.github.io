<script>
    import { clamp } from "../utils/math.js";
    import { onMount } from "svelte";

    export let scrollY = 0;

    let path;
    let pathLength;
    let dashArray;
    let mounted;
    let windowAspectRatio;

    const setPathLength = () => {
        pathLength = path.getTotalLength();
        dashArray = [pathLength, pathLength];
    };

    const svgAspectRatio = (4290 / 2366)
    let scrollProgress = 0;
    let start = 0;
    // let end = 1;
    // let diff = 0;

    onMount(() => {
        mounted = true;
    });

    $: diff =  (1 - svgAspectRatio / windowAspectRatio);
    $: end = svgAspectRatio < windowAspectRatio ? 1 - diff : 1;

    $: if (mounted && document) {
        scrollProgress = start + clamp(scrollY / (document.body.offsetHeight - window.innerHeight), 0, 1) * (end - start);
    }

    $: if (path) {
        path.style.strokeDashoffset = 1 - scrollProgress;
    }

    $: if (mounted && window) {
        windowAspectRatio = window.innerWidth / window.innerHeight
    }
</script>

<div class="progress-container">
    <svg
        xmlns="http://www.w3.org/2000/svg"
        version="1.1"
        viewBox="0 0 4290 2366"
        width="100%"
        height="100%"
        preserveAspectRatio={windowAspectRatio > svgAspectRatio ? "xMinYMin slice" : "xMaxYMax slice"}
        xmlns:xlink="http://www.w3.org/1999/xlink"
    >

        <g>
            <path
                bind:this={path}
                on:resize={setPathLength}
                pathLength="1"
                stroke-width="2"
                stroke="#746F67"
                fill="none" 
                d="M 4214.5,-0.5 C 4215.17,-0.5 4215.83,-0.5 4216.5,-0.5C 4216.67,5.84209 4216.5,12.1754 4216,18.5C 4206.67,23.5705 4197.84,29.2371 4189.5,35.5C 4192.03,40.7242 4194.7,45.8909 4197.5,51C 4194.41,56.3494 4191.74,61.8494 4189.5,67.5C 4188.66,67.8417 4188.33,68.5084 4188.5,69.5C 4184.57,73.6283 4181.57,78.4617 4179.5,84C 4184.71,95.0915 4190.71,105.758 4197.5,116C 4204.16,116.5 4210.83,116.666 4217.5,116.5C 4217.5,127.833 4217.5,139.167 4217.5,150.5C 4217.67,151.492 4217.34,152.158 4216.5,152.5C 4216.57,152.062 4216.4,151.728 4216,151.5C 4207.5,156.753 4198.83,161.753 4190,166.5C 4190.09,169.702 4191.09,172.702 4193,175.5C 4194.85,177.903 4196.69,180.236 4198.5,182.5C 4198.5,183.167 4198.5,183.833 4198.5,184.5C 4192.44,193.601 4186.61,202.934 4181,212.5C 4179.87,214.345 4179.37,216.345 4179.5,218.5C 4178.78,217.449 4177.78,216.782 4176.5,216.5C 4177.78,216.782 4178.78,217.449 4179.5,218.5C 4182.54,222.892 4185.21,227.559 4187.5,232.5C 4187.02,233.478 4186.36,234.311 4185.5,235C 4176.58,240.041 4167.75,245.207 4159,250.5C 4158.5,261.161 4158.33,271.828 4158.5,282.5C 4164.69,282.823 4170.69,282.49 4176.5,281.5C 4177.5,281.833 4178.17,282.5 4178.5,283.5C 4180.97,289.103 4183.97,294.436 4187.5,299.5C 4178.24,305.157 4168.91,310.824 4159.5,316.5C 4158.5,327.146 4158.17,337.813 4158.5,348.5C 4164.87,348.17 4171.2,348.504 4177.5,349.5C 4180.61,354.738 4183.94,359.738 4187.5,364.5C 4187.83,365.167 4188.17,365.833 4188.5,366.5C 4188.06,366.435 4187.73,366.601 4187.5,367C 4190.76,372.187 4193.76,377.521 4196.5,383C 4193.76,388.479 4190.76,393.813 4187.5,399C 4187.73,399.399 4188.06,399.565 4188.5,399.5C 4187.83,400.5 4187.17,401.5 4186.5,402.5C 4183.03,406.762 4180.03,411.429 4177.5,416.5C 4171.2,417.496 4164.87,417.83 4158.5,417.5C 4158.83,428.52 4158.5,439.52 4157.5,450.5C 4148.14,455.51 4139.14,461.01 4130.5,467C 4132.91,471.813 4135.57,476.48 4138.5,481C 4151.16,481.5 4163.83,481.667 4176.5,481.5C 4177.17,481.5 4177.5,481.833 4177.5,482.5C 4180.69,487.866 4183.69,493.366 4186.5,499C 4177.86,504.99 4168.86,510.49 4159.5,515.5C 4158.18,526.326 4158.18,536.993 4159.5,547.5C 4159.5,548.5 4159.5,549.5 4159.5,550.5C 4158.83,561.341 4158.17,572.341 4157.5,583.5C 4148.04,588.466 4138.71,593.633 4129.5,599C 4132.9,604.297 4135.9,609.797 4138.5,615.5C 4135.55,621.073 4132.88,626.74 4130.5,632.5C 4130.5,633.167 4130.17,633.5 4129.5,633.5C 4126.14,638.374 4123.14,643.541 4120.5,649C 4126.45,659.069 4132.29,669.236 4138,679.5C 4144.74,680.479 4151.58,680.812 4158.5,680.5C 4158.5,691.833 4158.5,703.167 4158.5,714.5C 4158.5,715.167 4158.5,715.833 4158.5,716.5C 4148.61,721.113 4138.95,726.279 4129.5,732C 4132.5,737 4135.5,742 4138.5,747C 4145.16,747.5 4151.83,747.666 4158.5,747.5C 4158.33,758.838 4158.5,770.172 4159,781.5C 4167.62,786.892 4176.45,791.892 4185.5,796.5C 4186.17,797.5 4186.83,798.5 4187.5,799.5C 4183.82,804.347 4180.48,809.513 4177.5,815C 4181.03,820.369 4184.37,825.869 4187.5,831.5C 4178.08,837.293 4168.58,842.959 4159,848.5C 4158.5,859.161 4158.33,869.828 4158.5,880.5C 4164.69,880.823 4170.69,880.49 4176.5,879.5C 4177.17,879.5 4177.5,879.833 4177.5,880.5C 4183.44,891.552 4189.78,902.385 4196.5,913C 4202.82,913.5 4209.16,913.666 4215.5,913.5C 4215.17,924.679 4215.51,935.679 4216.5,946.5C 4216.07,947.71 4215.4,948.71 4214.5,949.5C 4205.23,954.137 4196.23,959.304 4187.5,965C 4190.4,969.981 4193.4,974.815 4196.5,979.5C 4196.5,980.5 4196.5,981.5 4196.5,982.5C 4190.32,993.019 4183.98,1003.52 4177.5,1014C 4181.64,1019.45 4184.81,1025.29 4187,1031.5C 4177.67,1036.83 4168.33,1042.17 4159,1047.5C 4158.5,1058.16 4158.33,1068.83 4158.5,1079.5C 4164.17,1079.5 4169.83,1079.5 4175.5,1079.5C 4176.17,1079.5 4176.83,1079.5 4177.5,1079.5C 4180.18,1085.69 4183.51,1091.52 4187.5,1097C 4178.33,1102.75 4169,1108.25 4159.5,1113.5C 4158.5,1124.15 4158.17,1134.81 4158.5,1145.5C 4164.87,1145.17 4171.2,1145.5 4177.5,1146.5C 4180.27,1151.73 4183.27,1156.73 4186.5,1161.5C 4186.5,1162.83 4186.5,1164.17 4186.5,1165.5C 4177.03,1169.82 4167.86,1174.82 4159,1180.5C 4158.5,1191.83 4158.33,1203.16 4158.5,1214.5C 4151.58,1214.19 4144.74,1214.52 4138,1215.5C 4132.17,1225.83 4126.33,1236.17 4120.5,1246.5C 4123.27,1251.73 4126.27,1256.73 4129.5,1261.5C 4129.83,1262.17 4130.17,1262.83 4130.5,1263.5C 4132.91,1268.43 4135.58,1273.26 4138.5,1278C 4145.16,1278.5 4151.83,1278.67 4158.5,1278.5C 4158.18,1290.08 4158.51,1301.58 4159.5,1313C 4167.93,1317.97 4176.43,1322.8 4185,1327.5C 4188.66,1322.87 4191.82,1317.87 4194.5,1312.5C 4200.13,1311.5 4205.79,1311.17 4211.5,1311.5C 4214.17,1311.5 4216.83,1311.5 4219.5,1311.5C 4224.51,1311.33 4229.51,1311.5 4234.5,1312C 4237.4,1316.98 4240.4,1321.81 4243.5,1326.5C 4243.5,1328.17 4243.5,1329.83 4243.5,1331.5C 4234.28,1336.04 4225.28,1341.04 4216.5,1346.5C 4215.5,1357.81 4215.17,1369.15 4215.5,1380.5C 4208.8,1380.17 4202.13,1380.5 4195.5,1381.5C 4189.56,1391.71 4183.9,1402.04 4178.5,1412.5C 4180.67,1417.52 4183.34,1422.18 4186.5,1426.5C 4187.17,1427.83 4187.83,1429.17 4188.5,1430.5C 4191.02,1435.03 4193.68,1439.53 4196.5,1444C 4202.82,1444.5 4209.16,1444.67 4215.5,1444.5C 4214.86,1456.22 4215.52,1467.55 4217.5,1478.5C 4217.17,1479.17 4216.83,1479.83 4216.5,1480.5C 4213.98,1480.76 4211.65,1481.59 4209.5,1483C 4202,1487.25 4194.67,1491.75 4187.5,1496.5C 4190.59,1500.93 4193.26,1505.59 4195.5,1510.5C 4201.98,1511.49 4208.65,1511.82 4215.5,1511.5C 4215.17,1523.01 4215.51,1534.35 4216.5,1545.5C 4216.5,1546.17 4216.17,1546.5 4215.5,1546.5C 4206.17,1551.5 4197.17,1557 4188.5,1563C 4190.91,1567.81 4193.57,1572.48 4196.5,1577C 4202.82,1577.5 4209.16,1577.67 4215.5,1577.5C 4215.17,1588.85 4215.5,1600.19 4216.5,1611.5C 4225.19,1616.51 4233.86,1621.51 4242.5,1626.5C 4243.71,1626.93 4244.71,1627.6 4245.5,1628.5C 4242.07,1633.85 4238.73,1639.35 4235.5,1645C 4238,1649.5 4240.5,1654 4243,1658.5C 4243.67,1659.25 4244.5,1659.59 4245.5,1659.5C 4245.84,1661.48 4245.18,1662.82 4243.5,1663.5C 4234.09,1668.96 4224.59,1674.29 4215,1679.5C 4205.52,1674.43 4196.19,1669.09 4187,1663.5C 4183.96,1668.42 4180.79,1673.25 4177.5,1678C 4183.48,1688.81 4189.82,1699.31 4196.5,1709.5C 4196.5,1710.83 4196.5,1712.17 4196.5,1713.5C 4190.32,1724.02 4183.98,1734.52 4177.5,1745C 4181.03,1750.37 4184.37,1755.87 4187.5,1761.5C 4178.08,1767.29 4168.58,1772.96 4159,1778.5C 4158.5,1789.16 4158.33,1799.83 4158.5,1810.5C 4164.54,1810.83 4170.54,1810.5 4176.5,1809.5C 4179.35,1803.79 4182.68,1798.46 4186.5,1793.5C 4196.06,1799.11 4205.73,1804.44 4215.5,1809.5C 4216.34,1809.84 4216.67,1810.51 4216.5,1811.5C 4215.51,1821.99 4215.17,1832.65 4215.5,1843.5C 4221.69,1843.82 4227.69,1843.49 4233.5,1842.5C 4234.17,1842.83 4234.83,1843.17 4235.5,1843.5C 4238.31,1849.8 4241.65,1855.8 4245.5,1861.5C 4244.83,1861.83 4244.17,1862.17 4243.5,1862.5C 4234.09,1867.96 4224.59,1873.29 4215,1878.5C 4205.52,1873.43 4196.19,1868.09 4187,1862.5C 4183.83,1867.5 4180.67,1872.5 4177.5,1877.5C 4181.36,1883.23 4184.7,1889.23 4187.5,1895.5C 4187.5,1896.17 4187.17,1896.5 4186.5,1896.5C 4176.71,1900.31 4167.54,1905.31 4159,1911.5C 4158.5,1922.83 4158.33,1934.16 4158.5,1945.5C 4151.83,1945.33 4145.16,1945.5 4138.5,1946C 4135.71,1950.42 4133.04,1954.92 4130.5,1959.5C 4137.12,1964.49 4144.12,1968.99 4151.5,1973C 4153.91,1974.88 4156.58,1975.55 4159.5,1975C 4168.42,1969.96 4177.25,1964.79 4186,1959.5C 4189.92,1964.34 4193.09,1969.67 4195.5,1975.5C 4202.47,1976.5 4209.47,1976.83 4216.5,1976.5C 4216.5,1977.17 4216.5,1977.83 4216.5,1978.5C 4215.83,1989.34 4215.17,2000.34 4214.5,2011.5C 4205.38,2016.49 4196.71,2021.99 4188.5,2028C 4190.44,2032.72 4192.78,2037.22 4195.5,2041.5C 4207.82,2042.5 4220.15,2042.83 4232.5,2042.5C 4233.5,2042.5 4234.5,2042.5 4235.5,2042.5C 4237.94,2048.71 4240.94,2054.71 4244.5,2060.5C 4235.08,2066.29 4225.58,2071.96 4216,2077.5C 4215.83,2082.83 4215.67,2088.17 4215.5,2093.5C 4215.51,2099.21 4216.17,2104.54 4217.5,2109.5C 4217.17,2110.17 4216.83,2110.83 4216.5,2111.5C 4215.83,2122.34 4215.17,2133.34 4214.5,2144.5C 4205.34,2149.58 4196.34,2154.91 4187.5,2160.5C 4190.5,2165.83 4193.5,2171.17 4196.5,2176.5C 4193.22,2182.06 4190.22,2187.73 4187.5,2193.5C 4187.17,2194.17 4186.83,2194.83 4186.5,2195.5C 4183.52,2200.1 4180.52,2204.77 4177.5,2209.5C 4183.8,2220.44 4189.8,2231.44 4195.5,2242.5C 4202.17,2242.5 4208.83,2242.5 4215.5,2242.5C 4215.17,2253.68 4215.51,2264.68 4216.5,2275.5C 4216.17,2276.17 4215.83,2276.83 4215.5,2277.5C 4205.82,2282.04 4196.82,2287.54 4188.5,2294C 4190.91,2298.81 4193.57,2303.48 4196.5,2308C 4202.82,2308.5 4209.16,2308.67 4215.5,2308.5C 4215.17,2319.85 4215.5,2331.19 4216.5,2342.5C 4225.39,2347.78 4234.39,2352.78 4243.5,2357.5C 4244.17,2357.5 4244.5,2357.83 4244.5,2358.5C 4243.76,2360.98 4242.76,2363.31 4241.5,2365.5"/>
        </g>
    </svg>
</div>

<style>
    .progress-container {
        pointer-events: none;
        position: fixed;
        height: 100vh;
        width: 100vw;
        top: 0px;
        left: 0px;
        opacity: 1;
        display: flex;
        justify-content: right;
        -webkit-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        z-index: 11; 
    }
    .progress-container svg {
        object-fit: cover;
        object-position: right;
        shape-rendering: geometricPrecision;
        text-rendering: geometricPrecision;
        image-rendering: optimizeQuality;
        fill-rule: evenodd;
        clip-rule: evenodd;
        -webkit-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
    }
    .progress-container path {
        stroke-dasharray: 1;
        stroke-dashoffset: 1;
        opacity: 1;
        -webkit-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
    }
    @media screen and (max-width: 1000px) {
        .progress-container {
            display: none;
        }
    }
</style>